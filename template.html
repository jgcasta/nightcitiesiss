    <link href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.7.0/ol.css" rel="stylesheet">
  <style type="text/css">
  .map {
    float: left;
    padding: 10px 10px;
    height: 475px;
    width: 475px;
  }
  .issLocation{
    loat: left;
  }
  .mapOSM {
    float: left;
    padding: 10px 10px 10px 10px;
    height:475px;
    width: 475px;
  }
  .mapVIIRS {
    float: left;
    padding: 10px 10px;
    height:300px;
    width: 475px;
  }  
  .txtISS {
    float: left;
    padding: 5px 5px;
    height:95px;
    width: 115px;
  }
  .txtOSM {
    float: left;
    padding: 5px 5px;
    height:95px;
    width: 200px;
  }
  .container {
    margin-right: 10px;
    margin-left: 10px;
    }
  </style>

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:10px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading large image...Please wait!
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->


<div class="row skeleton" style="width:1550px"> <!-- Start Skeleton Row-->
    <div class="span12" style="width:1550px"><!-- Start of Question and Submission DIV (column) -->
        <h1 id="question">Do you know about this City?</h1> <!-- The question will be loaded here -->
<div><a href='https://www.kickstarter.com/projects/1550160587/cities-at-night' target='_blank'><img src="http://www.citiesatnight.org/img/logokickstarter.jpg"></a></div>        
        <div id="step1" class="btn-group" style="text-align:center"> <!-- Start DIV for the submission buttons -->
            <div id="answer" class="btn-group" style="text-align:center"> <!-- Start DIV for the submission buttons -->
                <button class="btn btn-large btn-answer" value='save'>Save</button>
                <button class="btn btn-large btn-answer" value='404'>No photo</button>
                <button class="btn btn-large btn-answer" value='unknown'>I don't know</button>
            </div><!-- End of DIV for the submission buttons -->
        </div><!-- End of DIV for the submission buttons -->

        <!-- Link to picture data provided by NASA site -->

        <div>
          <span class="label label-danger" id="i18n_wait">Please, be patient with large ISS images</span><br><br>
          <span id="i18n_zoom">Green point indicates either the likely city from Lost At Night, or the original ISS location at picture time. 
          Use the [+] and [-] buttons to Zoom In and Zoom Out. The VIIRS maps will be updated whe you change the central view
          Keep Shift + Left mouse button pressed while moving the mouse will rotate the image.</span><br>Please, try to place a point over every yellow rectangle of the image
          <a id="hrefPicture" href='' target='_blank'>ISS picture data - Earth Science and Remote Sensing Unit, NASA-Johnson Space Center. "The Gateway to Astronaut Photography of Earth."</a>
          </div>


        <!-- These are maps -->
        <div id="map" class="map"></div>
        <div id="mapOSM" class="mapOSM"></div>
        

        <!-- DataList to save  -->
        <form id='dataList' name='dataList'>
          &nbsp;<input type='button'   onClick="removeOptions()"; value='Remove Selected'><br>
            &nbsp;<span class="label label-info">X,Y and Lon,Lat coordinates</span><br>
            &nbsp;<SELECT id="xyValues" NAME="xyValues" class="txtISS" MULTIPLE size=5 width=5></SELECT>
            <SELECT id="lonlatValues" NAME="lonlatValues" class="txtOSM" MULTIPLE size=5 width=7></SELECT>
            <br><br><br><br><br><br>
            <span class="label label-info" id="i18n_viirs">2012 Night View from NPP-VIIRS</span>
            <div id="mapVIIRS" class="mapVIIRS"></div>
        </form>
    </div><!-- End of DIV for the submission buttons -->

        <!-- -------------- Social buttons ------------- -->
        <div>
          <div id="Twitter-share-section" style='float: left'>
                    <a href="https://twitter.com/share" class="twitter-share-button" data-text="Check this amazing picture and help us to georreference it" data-size="large" data-hashtags="NightCitiesISS">Tweet</a>
                </div>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
          </div> <!-- end twitter -->
                  
          <div class="g-plusone" style="float:left" data-annotation="inline" data-width="300"></div>

          <script type="text/javascript">
            window.___gcfg = {lang: 'es'};

            (function() {
              var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
              po.src = 'https://apis.google.com/js/platform.js';
              var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
            })();
          </script>
          <div style="float:left"> 
          <div id="fb-like" class="fb-like"  data-href="http://www.cowdcrafting.org/app/nightcitiesiss" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
            <div id="fb-root"></div>
          </div>
          <script>(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/es_ES/sdk.js#xfbml=1&version=v2.0";
            fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));</script>
          </div>
          <!-- -------------- End social buttons -------------------- -->

</div><!-- End of DIV for the submission buttons -->


<div class="row skeleton" style="margin-top:15px;"> <!-- Start Skeleton Row-->
    <div class="span8 offset2"><!-- Start of Question and Submission DIV (column) -->
        <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
        <p>You have completed: <span id="done" class="label label-info"></span> tasks from
        <!-- Progress bar for the user -->
        <span id="total" class="label label-info"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
        </div>
        <!-- 
            This application uses Disqus to allow users to provide some feedback.
            The next section includes a button that when a user clicks on it will
            load the comments, if any, for the given task
        -->
        <div id="disqus_show_btn" style="margin-top:5px;">
            <button class="btn btn-primary btn-large btn-disqus" onclick="loadDisqus()"><i class="icon-comments"></i> Show comments</button>
            <button class="btn btn-large btn-disqus" onclick="loadDisqus()" style="display:none"><i class="icon-comments"></i> Hide comments</button>
        </div><!-- End of Disqus Button section -->
        <!-- Disqus thread for the given task -->
        <div id="disqus_thread" style="margin-top:5px;display:none"></div>
    </div><!-- End of Question and Submission DIV (column) -->
</div><!-- End of Skeleton Row -->

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    /* * * DON'T EDIT BELOW THIS LINE * * */
    function loadDisqus() {
    $("#disqus_thread").toggle();
    $(".btn-disqus").toggle();
    var disqus_shortname = 'pybossa'; 
    //var disqus_identifier = taskId;
    var disqus_developer = 1;

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    }

</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 <!-- <script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script> -->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.7.0/ol.js" type="text/javascript"></script>
 <script src="https://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>
 <script src="https://openlayers.org/api/OpenLayers.js"></script>
 <!-- <script src="https://earthdata.nasa.gov/labs/gibs/examples/openlayers2/lib/openlayers-2.13.1/OpenLayers.js"></script> -->
 <script src="https://raw.githubusercontent.com/jgcasta/gibs-web-examples/release/openlayers2/lib/openlayers-2.13.1/OpenLayers.js"></script>
<script>
function loadUserProgress() {
    pybossa.userProgress('nightcitiesiss').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);

    });
}

var xy;
var lonlat;
var clickImg = false;
var clickMap = false;
var urlImage = '';
var urlImageFirst = 'http://eol.jsc.nasa.gov/sseop/images/ESC/small/ISS030/ISS030-E-67805.JPG';


pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {

        $("#success").hide();
        

        task.answer = {
            'imageResult' : '',
            'XY': '',
            'LONLAT': '',
            'img_big': task.info.link_big,
            'dimX': '',
            'dimY': ''
        }

        deferred.resolve(task);

    }
    else {
        deferred.resolve(task);

    }
    updateTwitterValues(window.location.href);
});

pybossa.presentTask(function(task, deferred) {

    if ( !$.isEmptyObject(task) ) {
        
        loadUserProgress();
        $("#hrefPicture").attr("href",task.info.linkData);
        $("#fb-like").attr("data-href",task.info.linkData);
            
        // first time I load the whole map
        if (firstTime){

            loadOSM(task.info.citylon,task.info.citylat,9);
            loadISSImage(task.info.link_big.replace('sseop/images','DatabaseImages'));

            firstTime = false;
        }
        else {
          removeAllOptions();
          //center OSM map if aprox location is known
          if (task.info.citylon != ''){
            changeMapOSM(task.info.citylon,task.info.citylat,7);
          }else{
            changeMapOSM(0,0,1);
          }
          loadNewISSImage(task.info.link_big.replace('sseop/images','DatabaseImages'));
        }

        $("#question").html(task.info.question);
        $('#task-id').html(task.id);
        $('.btn-answer').off('click').on('click', function(evt) {


            var answer = $(evt.target).attr("value");
            urlImage = task.info.link_big.replace('sseop/images','DatabaseImages');


            if (typeof answer != 'undefined') {

              if (answer == 'save'){

                $("#step1").hide();

                task.answer.XY = readAllValues(document.dataList.xyValues);
                task.answer.LONLAT = readAllValues(document.dataList.lonlatValues);
                xy = '';
                lonlat = '';
                task.answer.dimX = dimX;
                task.answer.dimY = dimY;

                // Prueba para controlar el array de puntos y localización
                if (verifyPoints()){
                    $("#step1").show();
                    $("#success").show();
                    pybossa.saveTask(task.id, task.answer).done(function() {
                          deferred.resolve();
                    });
                    $("#success").hide();
                    console.log('datos salvados');
                } else {
                    $("#step1").show();	
                }

              }else if (answer == '404'){
                task.answer.imageResult = '404';
                pybossa.saveTask(task.id, task.answer).done(function() {
                  deferred.resolve();
                });

              }else {

                task.answer.imageResult = 'unknown';
                pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                });
              }

            }
        });

    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn(500);
    }
});

function updateTwitterValues(share_url) {
    $("#Twitter-share-section").html('&nbsp;'); 
    $("#Twitter-share-section").html('<a href="https://twitter.com/share" class="twitter-share-button" data-url="'+share_url+'" data-text="Check out this amazing image!" data-size="large" data-hashtags="citiesAtNight">Tweet</a>');
    twttr.widgets.load();
}

// functions to show ISS picture and OSM Map
var firstTime = true;
var clickImg = false;
var clickMap = false;

var pixelProjection;


var iconStyle = new ol.style.Style({
  image: new ol.style.Circle({
      radius: 3,
      fill: new ol.style.Fill({
          color: [255, 204, 102, 1]
      }),
      stroke: new ol.style.Stroke({
          color: [255, 204, 102, 1],
          width: 1.5
      })
  }),
  zIndex: 1
});

var iconStyleVIIRS = new ol.style.Style({
  image: new ol.style.Circle({
      radius: 5,
      fill: new ol.style.Fill({
          color: [0, 204, 0, 1]
      }),
  }),
  zIndex: 1
});

var iconFeature;
var map;
var ISSlayer;


var gridLayer;

function createISSLayer(urlImage, imgX, imgY){

     pixelProjection = new ol.proj.Projection({
      code: 'pixel',
      units: 'pixels',
      extent: [0, 0, eval(imgX), eval(imgY)] 

    });

    var x1 = eval(imgX) / 3;
    var x2 = x1 * 2;
    var y1 = eval(imgY) / 3;
    var y2 = y1 * 2;

    var gridStyle =   new ol.style.Style({
                        stroke: new ol.style.Stroke({
                          color: 'yellow',
                          width: 1
                        })
                      });

    var gridGeoJSON = '{"type":"Feature","geometry":{ "type": "MultiLineString", "coordinates": [ ';
        gridGeoJSON += '                [ [' + x1 + ', 0.0], [' + x1 + ', ' + imgY + '] ] , ';
        gridGeoJSON += '                [ [' + x2 + ', 0.0], [' + x2 + ', ' + imgY + '] ] , ';        
        gridGeoJSON += '                [ [0.0, ' + y1 + '], [' + imgX + ', ' + y1 + '] ] , ';            
        gridGeoJSON += '                [ [0.0, ' + y2 + '], [' + imgX + ', ' + y2 + '] ] ] ';             
        gridGeoJSON += '            }}';
    /*
    gridLayer = new ol.layer.Vector({
        source: new ol.source.GeoJSON({
            text: gridGeoJSON
        }),
        style: gridStyle
    });
    */
    ISSlayer = new ol.layer.Image({
        source: new ol.source.ImageStatic({
          attributions: [
            new ol.Attribution({
              html: '<a href="http://guaix.fis.ucm.es/DarkSkies">ISS - GUAIX UCM</a>'
            })
          ],
          url: urlImage,
          imageSize: [eval(imgX), eval(imgY)],
          projection: pixelProjection,
          imageExtent: pixelProjection.getExtent()
        })
      });
}

var dimX,dimY;

function loadISSImage(urlImage){
  $("#loading").show();
  var dim = new Array();
  var img = new Image();
  img.onload = function() {
      
      dim[0] = this.width;
      dim[1] = this.height;
      
      dimX = dim[0];
      dimY = dim[1];

      createISSLayer(urlImage, dimX, dimY); 
      
      map = new ol.Map({

        interactions: ol.interaction.defaults().extend([
          new ol.interaction.DragRotateAndZoom()
        ]),
        //layers: [ISSlayer,gridLayer],
        layers: [ISSlayer],

        target: 'map',

        view: new ol.View({
          projection: pixelProjection,
          center: ol.extent.getCenter(pixelProjection.getExtent()),
          zoom: 1
        })
      });

      map.on('click', function(evt) {
        var coordinate = evt.coordinate;
        var xy = ol.coordinate.toStringXY(ol.proj.transform(coordinate, pixelProjection, pixelProjection));

        if (clickImg == false){
          
          addOption(document.dataList.xyValues, xy,xy);

          addPointLayer();
          clickImg = true;
          clickMap = false;

        }
      });
      $("#loading").hide();
  } // img.load
  img.src = urlImage;
  
} // loadISSImage

function unloadISSImage(){
  window.map.removeLayer(ISSlayer);
}

function loadNewISSImage(urlImage){
  $("#loading").show();
  $('#map').hide();
  var dim = new Array();
  var img = new Image();
  img.onload = function() {
    
    dim[0] = this.width;
    dim[1] = this.height;
    
    dimX = dim[0];
    dimY = dim[1];
  
    map.removeLayer(ISSlayer);
    createISSLayer(urlImage, dimX, dimY); 
    map.addLayer(ISSlayer);
    map.addLayer(gridLayer);
    $('#map').show();

    $("#loading").hide();

  } // img.load
  img.src = urlImage;
}


function handleMapClick(evt) {

      if (clickMap == false){
        
        var lonlat = mapOSM.getLonLatFromViewPortPx(evt.xy).transform(new OpenLayers.Projection("EPSG:900913"), new OpenLayers.Projection("EPSG:4326"));
        var coord = lonlat.lon.toFixed(6) + ',' + lonlat.lat.toFixed(6);

        addOption(document.dataList.lonlatValues, coord,coord);
        
        addPointLayerOSM();
        clickMap = true;
        clickImg = false;
        mapOSM.addLayer(pointLayerOSM);  
      }
    } 

function handleMapMoveStart(evt){
  
  var lonlat = mapOSM.getCenter().transform(new OpenLayers.Projection("EPSG:900913"), new OpenLayers.Projection("EPSG:4326"));
  updateMapVIIRS(lonlat.lon.toFixed(6), lonlat.lat.toFixed(6), mapOSM.getZoom());
}

function updateMapVIIRS(lonOSM, latOSM, zoomOSM){

  mapVIIRS.getView().setZoom(zoomOSM - 1);
  mapVIIRS.getView().setCenter([eval(lonOSM),eval(latOSM)]);

}

var mapOSM;
var osmlayer = new OpenLayers.Layer.OSM();
var gmaplayerSt = new OpenLayers.Layer.Google("Google Streets",{numZoomLevels: 20});
var gmaplayerSat = new OpenLayers.Layer.Google("Google Satellite",{type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22});

var viirs2014OSM = new OpenLayers.Layer.WMS( "VIIRS 2014", "https://mapsengine.google.com/06518876839643628417-03711100469230671386-4/wms/", {layers: '06518876839643628417-13259596722140817478-4', srs:'4326',format: 'image/png',} );

var fromProjection = new OpenLayers.Projection("EPSG:4326");   
var toProjection   = new OpenLayers.Projection("EPSG:900913");

function loadOSM(lonOSM, latOSM, zoomOSM){

    mapOSM = new OpenLayers.Map({
        div: "mapOSM",
         //projection: "EPSG:4326",
         maxResolution: 'auto'
      });

// create point in OSM map with task coordinates
 	  var locationPointLayer = new OpenLayers.Layer.Vector('LostAtNight Location', {
 	    styleMap: new OpenLayers.StyleMap({
 	      pointRadius: "5",
	      fillColor: "#00cc00",
	      strokeWidth: "0"
	      }),
	    renderers: renderer
	    });
	  var point = new OpenLayers.Geometry.Point(eval(lonOSM),eval(latOSM));
	  point.transform(fromProjection, toProjection);
	  var featureP = new OpenLayers.Feature.Vector(point);
	  locationPointLayer.addFeatures([featureP]);


    mapOSM.addLayers([gmaplayerSt,gmaplayerSat,osmlayer,viirs2014OSM, locationPointLayer]);
    
    mapOSM.addControl(new OpenLayers.Control.LayerSwitcher());

    var centerPosition = new OpenLayers.LonLat(eval(lonOSM),eval(latOSM)).transform( fromProjection, toProjection);
    mapOSM.setCenter(centerPosition, zoomOSM );

    mapOSM.events.register('click', mapOSM, handleMapClick);
    mapOSM.events.register('moveend', mapOSM, handleMapMoveStart);  

    //load VIIRS help map
   var viirs2014 = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        //url: 'http://webservices.nationalatlas.gov/wms?people',
        //url:'https://mapsengine.google.com/06518876839643628417-03711100469230671386-4/wms/REQUEST=GetCapabilities',
        url:'https://mapsengine.google.com/06518876839643628417-03711100469230671386-4/wms/',
        params: {'LAYERS': '06518876839643628417-13259596722140817478-4',transparent:'true',srs: '4326'}

        
        }),
        opacity:'1.0'
    });
    mapVIIRS = new ol.Map({
      target: 'mapVIIRS',
      layers: [
        viirs2014 //viirs
      ],

      view: new ol.View({
        projection: ol.proj.get("EPSG:4326"),
                    extent: [-180, -90, 180, 90],
            center: [0, 0],
            zoom: 1
      })
    });

    var icons = [];
    nadirISS = new ol.Feature({ geometry: new ol.geom.Point([eval(lonOSM),eval(latOSM)])});
    nadirISS.setStyle(iconStyleVIIRS);
    icons.push(nadirISS); 

    nadirLayer = new ol.layer.Vector({ source: new ol.source.Vector({ features: icons }) });
  
    mapVIIRS.addLayer(nadirLayer);

    updateMapVIIRS(eval(lonOSM),eval(latOSM),zoomOSM);

}

function changeMapOSM(lonOSM, latOSM, zoomOSM){

  // change OSM
  var centerPosition = new OpenLayers.LonLat(eval(lonOSM),eval(latOSM)).transform( fromProjection, toProjection);
  mapOSM.setCenter(centerPosition, zoomOSM );

  // update point with lat and lon values
	var locationPointLayer = mapOSM.getLayersByName('Location')[0];
  if(typeof locationPointLayer != 'undefined'){
	   locationPointLayer.removeAllFeatures();
  }
	var point = new OpenLayers.Geometry.Point(eval(lonOSM),eval(latOSM));
	point.transform(fromProjection, toProjection);
	var featureP = new OpenLayers.Feature.Vector(point);
   if(typeof locationPointLayer != 'undefined'){
     locationPointLayer.addFeatures([featureP]);
  }
	
	 
  // change VIIRS
  mapVIIRS.removeLayer(nadirLayer);
  var icons = [];
  nadirISS = new ol.Feature({ geometry: new ol.geom.Point([eval(lonOSM),eval(latOSM)])});
  nadirISS.setStyle(iconStyleVIIRS);
  icons.push(nadirISS); 

  nadirLayer = new ol.layer.Vector({ source: new ol.source.Vector({ features: icons }) });

  mapVIIRS.addLayer(nadirLayer);

}

function addPointLayer(){

  window.map.removeLayer(pointLayer);

  var pos = [];
  var icons = [];
  
  for(i=0;i<dataList.xyValues.options.length;i++){
    
    if(typeof dataList.xyValues.options[i].value != 'undefined'){
      
      pos = dataList.xyValues.options[i].value.split(',');

      iconFeature = new ol.Feature({ geometry: new ol.geom.Point([eval(pos[0]), eval(pos[1])])});
      iconFeature.setStyle(iconStyle);
      icons.push(iconFeature);    

    }
  }  

  pointLayer = new ol.layer.Vector({ 
    source: new ol.source.Vector({ features: icons }) 
  })
  
  map.addLayer(pointLayer);

}


var pointLayer;

var renderer = OpenLayers.Util.getParameters(window.location.href).renderer;
renderer = (renderer) ? [renderer] : OpenLayers.Layer.Vector.prototype.renderers;
var pointLayerOSM = new OpenLayers.Layer.Vector('Points', {
        styleMap: new OpenLayers.StyleMap({
            pointRadius: "5", 
            fillColor: "#fc0000"
        }),
        renderers: renderer
    });
function addPointLayerOSM(){
  
    var posOSM = [];
    var features = new Array(50);
  
    for(i=0;i<dataList.lonlatValues.options.length ;i++){

        if(typeof dataList.lonlatValues.options[i].value != 'undefined'){
          
            posOSM = dataList.lonlatValues.options[i].value.split(',');

            var point = new OpenLayers.Geometry.Point(eval(posOSM[0]), eval(posOSM[1]));
            point.transform(fromProjection, toProjection);
            var featureP = new OpenLayers.Feature.Vector(point);

            pointLayerOSM.addFeatures([featureP]);
        }
    }  

}

function removePoint(){

  window.map.removeLayer(pointLayer);

  if(typeof pointLayerOSM != 'undefined'){
    pointLayerOSM.destroyFeatures();
  }

}


var sourceViirs = new ol.source.WMTS({
    urls: [
        "https://map1a.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
        "https://map1b.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
        "https://map1c.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
    ],
    layer: "VIIRS_CityLights_2012",
    format: "image/jpeg",
    matrixSet: "EPSG4326_500m",
    tileGrid: new ol.tilegrid.WMTS({
        origin: [-180, 90],
        resolutions: [
            0.5625,
            0.28125,
            0.140625,
            0.0703125,
            0.03515625,
            0.017578125,
            0.0087890625,
            0.00439453125,
            0.002197265625
        ],
        matrixIds: [0, 1, 2, 3, 4, 5, 6, 7, 8],
        tileSize: 512
    }),
    attributions: [
        new ol.Attribution({html:"NASA NPP - VIIRS"})
    ]
});

var viirs = new ol.layer.Tile({source: sourceViirs});



// auxiliar functions

function addOption(selectbox,text,value ){
  var optn = document.createElement("OPTION");
  optn.text = text;
  optn.value = value;
  selectbox.options.add(optn);
}

var removed = false;
function removeOptions(){
	removed = true;
	pointLayerOSM.destroyFeatures();
	var m = dataList.xyValues.options.length;
	if (dataList.lonlatValues.options.length > m) { m = dataList.lonlatValues.options.length; }
	for(var i=m-1; i>=0; i--){
		if((i<dataList.xyValues.options.length && dataList.xyValues.options[i].selected) || (i<dataList.lonlatValues.options.length && dataList.lonlatValues.options[i].selected)){
			if(i<dataList.xyValues.options.length){
				window.map.removeLayer(pointLayer);
				dataList.xyValues.remove(i);
			}
			if(i<dataList.lonlatValues.options.length){
				dataList.lonlatValues.remove(i);
			}
		}
	}
	addPointLayer();
	addPointLayerOSM();
}

function removeAllOptions(){

    removePoint();

    document.getElementById('xyValues').options.length = 0;
    document.getElementById('lonlatValues').options.length = 0;

}

function readAllValues(selectbox){
  
  var i;
  var ret = new Array();
  for(i=0;i<selectbox.options.length;i++){
    
    if(typeof selectbox.options[i].value != 'undefined'){
      ret.push(selectbox.options[i].value + ';');
    }
  }  
  return ret;
}

function verifyPoints(){
  var countXY = document.getElementById('xyValues').options.length;
  var countLONLAT = document.getElementById('lonlatValues').options.length;
  var devolver = true;
  if (countXY != countLONLAT){
    alert('The number of points must be the same as lonlat');
    devolver = false;
  } else if (countXY == 0){
    alert('Please enter at least one point and matching lonlat');
    devolver = false;
  }
  return devolver;
}

function getIimDim(urlimage){
  var dim = new Array();
  var img = new Image();
  img.onload = function() {

    dim[0] = this.width;
    dim[1] = this.height;
  }
  img.src = urlimage;
  return dim;
}

pybossa.run('nightcitiesiss');
</script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1910419-4', 'citiesatnight.org');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>
